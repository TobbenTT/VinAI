version: "3.1"
rules:
- rule: Saludar al usuario
  steps:
  - intent: saludar
  - action: utter_saludar

- rule: Despedirse del usuario
  steps:
  - intent: despedirse
  - action: utter_despedirse

# --- Reglas de "no interrupción" (Están correctas) ---
- rule: Activar la recomendación de vino
  condition:
  - active_loop: null 
  steps:
  - intent: recomendar_vino
  - action: action_recomendar_vino_db

- rule: Dar recomendación DESPUÉS de informar gusto
  condition:
  - active_loop: null 
  steps:
  - intent: informar_gusto
  - action: action_recomendar_vino_db

- rule: Dar recomendación DESPUÉS de informar el año
  condition:
  - active_loop: null 
  steps:
  - intent: informar_ano
  - action: action_recomendar_vino_db

- rule: Activar la búsqueda de tour por viña
  condition:
  - active_loop: null 
  steps:
  - intent: buscar_tour_vina
  - action: action_buscar_tour

- rule: Activar la recomendación de tour
  condition:
  - active_loop: null 
  steps:
  - intent: recomendar_tour
  - action: action_recomendar_tour_db
# --- Fin de reglas de "no interrupción" ---

# === INICIO DE LA CORRECCIÓN ===

# REGLA 1: Activa el formulario
- rule: Activar formulario de valoración
  steps:
  - intent: valorar_tour
  - action: valorar_tour_form
  - active_loop: valorar_tour_form

# REGLA 2: Maneja la sumisión del formulario
# Esta es la regla que faltaba y que arregla el error.
# Le dice a RASA qué hacer DESPUÉS de que el formulario se desactiva.
- rule: Guardar valoración después de completar el formulario
  condition:
  # Esta condición se cumple cuando el formulario pide 'null' (es decir, terminó)
  - active_loop: valorar_tour_form
  - slot_was_set:
    - requested_slot: null
  steps:
  # El formulario se desactiva
  - action: valorar_tour_form
  - active_loop: null
  # ¡Llamamos a nuestra nueva acción de guardado!
  - action: action_guardar_valoracion_db
  - action: action_listen

# === FIN DE LA CORRECIÓN ===
  
- rule: Responder a la petición de ayuda
  steps:
  - intent: pedir_ayuda
  - action: utter_ayuda

- rule: Activar registro
  steps:
  - intent: registrar_usuario
  - action: action_registrar_usuario

- rule: Activar login
  steps:
  - intent: iniciar_sesion
  - action: action_iniciar_sesion

- rule: Guardar preferencia
  steps:
  - intent: guardar_preferencia_vino
  - action: action_guardar_preferencia